{#
Archivo: app/templates/pages/references.html
Proposito: Vista dedicada para normas de referencias bibliograficas.
Bloques: content (grid de normas + detalle tipo docs).
Donde tocar si falla: IDs usados por references.js y layout de vistas.
#}
{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto" id="referencesApp" data-uni="{{ active_uni or 'unac' }}">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">Referencias Bibliográficas</h1>
      <p class="text-sm text-gray-500 mt-1">Normas y ejemplos actualizados según universidad.</p>
    </div>
    <div class="inline-flex items-center gap-2 bg-white border border-gray-200 rounded-lg px-4 py-2 shadow-sm">
      <span class="text-xs uppercase tracking-wider text-gray-400">Universidad</span>
      <span class="text-sm font-semibold text-gray-800">{{ uni_name or 'Universidad' }}</span>
    </div>
  </div>

  <section id="refs-grid-view" class="space-y-6">
    <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h2 class="text-lg font-bold text-gray-900">Normas disponibles</h2>
        <p class="text-xs text-gray-500">Selecciona una norma para ver la guía completa.</p>
      </div>
      <div class="relative w-full md:w-72">
        <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
        <input id="refs-search" type="text" placeholder="Buscar norma..."
               class="w-full bg-gray-100 border border-transparent rounded-lg pl-9 pr-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all">
      </div>
    </div>

    <div id="refs-grid" class="refs-grid"></div>
    <div id="refs-grid-empty" class="hidden text-sm text-gray-500">No hay normas disponibles.</div>
  </section>

  <section id="refs-detail-view" class="hidden">
    <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
      <div id="ref-breadcrumb" class="text-xs text-gray-500">Referencias</div>
      <button id="refs-back-btn"
              class="inline-flex items-center gap-2 text-sm font-semibold text-indigo-600 hover:text-indigo-800">
        <i data-lucide="arrow-left" class="w-4 h-4"></i> Volver a normas
      </button>
    </div>

    <div class="flex items-center gap-3 mb-4 lg:hidden">
      <button id="refs-open-drawer" class="inline-flex items-center gap-2 text-sm font-semibold text-gray-700 bg-white border border-gray-200 rounded-lg px-3 py-2 shadow-sm">
        <i data-lucide="menu" class="w-4 h-4"></i> Normas
      </button>
    </div>

    <div class="refs-layout">
      <aside class="refs-sticky hidden lg:block">
        <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wider text-gray-400">Normas</div>
          <div class="relative mt-3">
            <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
            <input id="refs-side-search" type="text" placeholder="Buscar norma..."
                   class="w-full bg-gray-100 border border-transparent rounded-lg pl-9 pr-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all">
          </div>
          <div id="refs-side-list" class="space-y-2 mt-4"></div>
        </div>
      </aside>

      <main>
        <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
          <div id="ref-detail-header" class="space-y-3">
            <div class="flex flex-wrap items-center gap-2">
              <h2 id="ref-title" class="text-2xl font-bold text-gray-900"></h2>
              <div id="ref-tags" class="flex flex-wrap gap-2"></div>
            </div>
            <p id="ref-desc" class="text-sm text-gray-600"></p>
            <div id="ref-note" class="hidden ref-note"></div>
          </div>

          <div id="ref-detail-loader" class="flex items-center justify-center py-16">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
          </div>

          <div id="ref-content" class="hidden space-y-8 mt-6"></div>
          <div id="ref-sources" class="hidden mt-8 border-t border-gray-100 pt-4 text-sm text-gray-500"></div>
        </div>
      </main>

      <aside class="refs-sticky">
        <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
          <div class="text-xs uppercase tracking-wider text-gray-400">En esta guía</div>
          <div id="ref-toc" class="ref-toc">
            <div id="ref-toc-list"></div>
          </div>
        </div>
      </aside>
    </div>
  </section>
</div>

<div id="refs-drawer" class="refs-drawer hidden lg:hidden" aria-hidden="true">
  <div id="refs-drawer-backdrop" class="refs-drawer-backdrop"></div>
  <div class="refs-drawer-panel">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-sm font-bold text-gray-900">Normas</h3>
      <button id="refs-close-drawer" class="text-xs font-semibold text-gray-500 hover:text-gray-800">Cerrar</button>
    </div>
    <div class="relative">
      <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
      <input id="refs-drawer-search" type="text" placeholder="Buscar norma..."
             class="w-full bg-gray-100 border border-transparent rounded-lg pl-9 pr-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all">
    </div>
    <div id="refs-drawer-list" class="space-y-2 mt-4"></div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // 1. Detectar si venimos del catálogo
    const params = new URLSearchParams(window.location.search);
    const source = params.get("source");

    if (source === "catalog") {
      // A) Arreglar el botón "Volver"
      const backBtn = document.getElementById("refs-back-btn");
      if (backBtn) {
        // Cambiar texto y acción
        backBtn.innerHTML = '<i data-lucide="arrow-left" class="w-4 h-4"></i> Volver al Catálogo';
        backBtn.onclick = (e) => {
          e.preventDefault();
          window.location.href = "/catalog"; // Regresa forzosamente al catálogo
        };
      }

      // B) Arreglar el Menú Lateral (Círculo azul de tu imagen)
      // Buscamos el link del sidebar que apunta a /catalog y le ponemos la clase "active"
      const sidebarLinks = document.querySelectorAll('aside a, nav a'); // Ajusta el selector según tu sidebar.html
      
      sidebarLinks.forEach(link => {
        // Limpiar activos previos
        link.classList.remove('bg-blue-50', 'text-blue-700', 'font-semibold'); 
        link.classList.add('text-gray-600', 'hover:bg-gray-50');

        // Activar el de catálogo
        if (link.getAttribute('href') && link.getAttribute('href').includes('/catalog')) {
           link.classList.remove('text-gray-600', 'hover:bg-gray-50');
           link.classList.add('bg-blue-50', 'text-blue-700', 'font-semibold'); // Estilos de "activo"
        }
      });
    }
  });
</script>

<script src="/static/js/references.js?v=8"></script>
{% endblock %}
